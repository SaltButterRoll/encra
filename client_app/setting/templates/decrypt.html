{% extends "layout.html" %}

{% block title %}ì´ë¯¸ì§€ ë³µí˜¸í™” - ENCRA{% endblock %}

{% block page_title %}ì´ë¯¸ì§€ ë³µí˜¸í™”{% endblock %}

{% block additional_styles %}
<style>
    .decrypt-container {
        padding: 20px;
        max-width: 1400px; /* í•œê¸€ ì£¼ì„: ì „ì²´ ì»¨í…Œì´ë„ˆ í¬ê¸° ì¦ê°€ë¡œ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ í™•ì¥ */
    }

    .canvas-guide {
        margin-bottom: 10px;
        font-size: 18px;
        color: #4B5563;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* ë‘ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ (í•œê¸€ ì£¼ì„: encrypt.htmlê³¼ ë™ì¼í•œ ë ˆì´ì•„ì›ƒ) */
    .decrypt-layout {
        display: flex;
        gap: 24px;
        margin-top: 20px;
    }
    
    .left-column {
        flex: 1;
        min-width: 0; /* í”Œë ‰ìŠ¤ë°•ìŠ¤ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
    }
    
    .right-column {
        width: 300px; /* í•œê¸€ ì£¼ì„: ìš°ì¸¡ íŒ¨ë„ í¬ê¸° ì¶•ì†Œë¡œ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ë” ë„“ê²Œ í™•ë³´ */
        position: sticky;
        top: 20px;
        align-self: flex-start;
        margin-top: 38px; /* í•œê¸€ ì£¼ì„: canvas-guide ë†’ì´ì— ë§ì¶° ì •ë ¬ (18px + 10px margin + 10px ì—¬ìœ ) */
    }

    .preview-box {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background-color: #f8fafc;
        display: flex;
        align-items: center; /* í•œê¸€ ì£¼ì„: ë†’ì´ ì¤‘ì•™ ì •ë ¬ */
        justify-content: space-between;
        padding: 20px;
        gap: 20px;
        margin-bottom: 20px; /* í•œê¸€ ì£¼ì„: ì•”í˜¸í™” í˜ì´ì§€ì˜ canvas-containerì™€ ë™ì¼í•˜ê²Œ í•˜ë‹¨ ë§ˆì§„ë§Œ ì ìš© */
        min-height: 600px; /* í•œê¸€ ì£¼ì„: ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ ë†’ì´ ì¦ê°€ */
    }

    .image-column {
        flex: 1;
        display: flex;                /* ğŸ”¹ Flexbox ì ìš© */
        flex-direction: column;       /* ì„¸ë¡œ ë°©í–¥ ì •ë ¬ */
        align-items: center;          /* âœ… ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
        justify-content: center;      /* âœ… ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        text-align: center;
        position: relative;
        min-height: 500px; /* í•œê¸€ ì£¼ì„: ìµœì†Œ ë†’ì´ ì„¤ì •ìœ¼ë¡œ ì¤‘ì•™ì •ë ¬ ê¸°ì¤€ì  ì œê³µ */
    }

    .arrow-icon {
        font-size: 2rem;
        color: #9ca3af;
        align-self: center; /* í•œê¸€ ì£¼ì„: í™”ì‚´í‘œë„ ì¤‘ì•™ ì •ë ¬ */
    }
    .preview-image {
        max-width: 100%;
        display: none;
        max-height: 500px; /* í•œê¸€ ì£¼ì„: ë” í° ë¯¸ë¦¬ë³´ê¸° */
        border-radius: 8px;
    }

    .image-preview-text {
        color: #9CA3AF;
        font-size: 16px;
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ (í•œê¸€ ì£¼ì„: encrypt.htmlê³¼ ë™ì¼í•œ ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼) */
    .loading-spinner {
        display: none;
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #2563EB;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .upload-btn {
        background-color: #4F46E5;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .upload-btn:hover {
        background-color: #4338CA;
    }

    /* í¼ ìŠ¤íƒ€ì¼ (í•œê¸€ ì£¼ì„: encrypt.htmlê³¼ ë™ì¼í•œ ìš°ì¸¡ í¼) */
    .decrypt-form {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .form-group input {
        width: 100%;
        padding: 12px 14px;  /* ê¸°ì¡´ë³´ë‹¤ padding ì¦ê°€ */
        font-size: 15px;     /* placeholderê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ ê¸€ì í¬ê¸° ì§€ì • */
        line-height: 1.4;    /* ì¤„ ê°„ê²© ì¶”ê°€ë¡œ ê°€ë…ì„± ê°œì„  */
        border: 1px solid #d1d5db;
        border-radius: 6px;
    }

    .action-btn {
        background-color: #2563EB;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-bottom: 12px;
    }

    .action-btn:hover {
        background-color: #1D4ED8;
    }

    .action-btn:disabled {
        background-color: #9CA3AF;  /* íšŒìƒ‰ */
        cursor: not-allowed;
        color: white;
    }

    .back-btn {
        background-color: #6b7280;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        display: block;
        transition: background-color 0.2s;
        width: 100%;
    }

    .back-btn:hover {
        background-color: #4b5563;
    }

    .error {
        color: #DC2626;
        margin-top: 5px;
        font-size: 14px;
    }

    .loading-message {
        margin: 20px 0;
        font-size: 16px;
        color: #4B5563;
        text-align: center;
    }

    /* PDF í˜ì´ì§€ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ (í•œê¸€ ì£¼ì„: encrypt.htmlê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼) */
    #encryptedPdfControls button, #decryptedPdfControls button {
        background-color: #2563EB;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin: 0 4px;
    }

    #encryptedPdfControls button:hover, #decryptedPdfControls button:hover {
        background-color: #1D4ED8;
    }

    #encryptedPdfControls button:disabled, #decryptedPdfControls button:disabled {
        background-color: #9CA3AF;
        cursor: not-allowed;
    }

    #encPageInfo, #decPageInfo {
        display: inline-block;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 600;
        color: #4B5563;
    }

    /* ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ (í•œê¸€ ì£¼ì„: encrypt.htmlê³¼ ë™ì¼í•œ ë°˜ì‘í˜•) */
    @media (max-width: 900px) {
        .decrypt-layout {
            flex-direction: column;
        }
        
        .right-column {
            width: 100%;
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="decrypt-container">
    <div class="decrypt-layout">
        <div class="left-column">
            <div class="canvas-guide">ğŸ–¼ï¸ ì•”í˜¸í™”ëœ íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ê°„í¸í•˜ê²Œ ë³µí˜¸í™”í•˜ì„¸ìš”.</div>
            <div class="preview-box" id="previewBox">
                <div class="image-column">
                    <span class="image-preview-text" id="previewPlaceholder">ğŸ–¼ï¸ ì•”í˜¸í™”ëœ íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ê°„í¸í•˜ê²Œ ë³µí˜¸í™”í•˜ì„¸ìš”.</span>
                    <img id="encryptedImage" class="preview-image" alt="ì•”í˜¸í™” íŒŒì¼">
                    <canvas id="encryptedCanvas" width="500" height="400" style="display: none; max-width: 100%; border-radius: 8px;"></canvas>
                    <div id="encryptedLoadingSpinner" class="loading-spinner"></div>
                    
                    <!-- ì•”í˜¸í™”ëœ íŒŒì¼ìš© í˜ì´ì§€ ì»¨íŠ¸ë¡¤ (í•œê¸€ ì£¼ì„: ê° ë¯¸ë¦¬ë³´ê¸° ë°”ë¡œ ì•„ë˜ ë°°ì¹˜) -->
                    <div id="encryptedPdfControls" style="display:none; text-align:center; margin-top:12px;">
                        <button id="encPrevPageBtn" type="button">&lt; ì´ì „</button>
                        <span id="encPageInfo">1 / 1</span>
                        <button id="encNextPageBtn" type="button">ë‹¤ìŒ &gt;</button>
                    </div>
                </div>
                
                <div class="arrow-icon">â¡ï¸</div>
                
                <div class="image-column">
                    <span class="image-preview-text" id="decryptedPlaceholder">ë³µí˜¸í™”ëœ íŒŒì¼</span>
                    <img id="previewImage" class="preview-image" alt="ë³µí˜¸í™” ì´ë¯¸ì§€">
                    <canvas id="decryptedCanvas" width="500" height="400" style="display: none; max-width: 100%; border-radius: 8px;"></canvas>
                    <div id="decryptedLoadingSpinner" class="loading-spinner"></div>
                    
                    <!-- ë³µí˜¸í™”ëœ íŒŒì¼ìš© í˜ì´ì§€ ì»¨íŠ¸ë¡¤ (í•œê¸€ ì£¼ì„: ê° ë¯¸ë¦¬ë³´ê¸° ë°”ë¡œ ì•„ë˜ ë°°ì¹˜) -->
                    <div id="decryptedPdfControls" style="display:none; text-align:center; margin-top:12px;">
                        <button id="decPrevPageBtn" type="button">&lt; ì´ì „</button>
                        <span id="decPageInfo">1 / 1</span>
                        <button id="decNextPageBtn" type="button">ë‹¤ìŒ &gt;</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="decrypt-form">
                <div class="upload-section" style="margin-bottom: 20px;">
                    <button class="upload-btn" onclick="document.getElementById('imageInput').click()" style="width: 100%;">
                        íŒŒì¼ì°¾ê¸°
                    </button>
                    <input type="file" id="imageInput" accept=".jpg,.jpeg,.pdf" style="display: none;">
                    <div id="fileError" class="error"></div>
                </div>
                
                <div class="form-group">
                    <label for="outputFilename">ì €ì¥í•  íŒŒì¼ ì´ë¦„(ì„ íƒ):</label>
                    <input type="text" id="outputFilename" placeholder="ì˜ˆ: decrypted_image_dec">
                    <small style="color: #6b7280; display: block; margin-top: 6px;">
                        í™•ì¥ì ì œì™¸ í›„ ì…ë ¥í•´ì£¼ì„¸ìš”.
                    </small>
                    <small style="color: #6b7280; display: block; margin-top: 6px;">
                        ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì›ë³¸ íŒŒì¼ëª…_decë¡œ ì €ì¥ë©ë‹ˆë‹¤.
                    </small>
                </div>

                <button id="decryptButton" class="action-btn" disabled>ë³µí˜¸í™” ì‹œì‘</button>
                <button id="downloadButton" class="action-btn" style="display: none;">íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
                <a href="/" class="back-btn">ì²˜ìŒí™”ë©´ìœ¼ë¡œ</a>
            </div>
        </div>
    </div>

    <div id="loadingMessage" class="loading-message" style="display: none;">ë³µí˜¸í™” ì¤‘...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const imageInput = document.getElementById('imageInput');
        const previewImage = document.getElementById('previewImage');
        const decryptedPlaceholder = document.getElementById('decryptedPlaceholder');
        const encryptedImage = document.getElementById('encryptedImage');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const loadingMessage = document.getElementById('loadingMessage');
        const downloadButton = document.getElementById('downloadButton');
        const errorDiv = document.getElementById('fileError');
        
        // PDF ê´€ë ¨ ë³€ìˆ˜ë“¤ (í•œê¸€ ì£¼ì„: encrypt.htmlê³¼ ë™ì¼í•œ PDF ì²˜ë¦¬ ë¡œì§)
        let currentFileType = null;
        let encryptedPdfPages = [];
        let decryptedPdfPages = [];
        let currentEncPage = 0;
        let currentDecPage = 0;

        // íŒŒì¼ ì´ˆê¸°í™” í•¨ìˆ˜ (í•œê¸€ ì£¼ì„: ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ ì´ì „ ë¯¸ë¦¬ë³´ê¸° ì œê±°)
        function resetPreview() {
            previewImage.style.display = 'none';
            encryptedImage.style.display = 'none';
            document.getElementById('encryptedCanvas').style.display = 'none';
            document.getElementById('decryptedCanvas').style.display = 'none';
            previewPlaceholder.style.display = 'block';
            decryptedPlaceholder.style.display = 'block';
            downloadButton.style.display = 'none';
            loadingMessage.style.display = 'none';
            document.getElementById('encryptedPdfControls').style.display = 'none';
            document.getElementById('decryptedPdfControls').style.display = 'none';
            document.getElementById('decryptButton').disabled = true;
            errorDiv.textContent = '';
            
            // ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸° (í•œê¸€ ì£¼ì„: ëª¨ë“  ìŠ¤í”¼ë„ˆ ì´ˆê¸°í™”)
            document.getElementById('encryptedLoadingSpinner').style.display = 'none';
            document.getElementById('decryptedLoadingSpinner').style.display = 'none';
            
            // PDF ë³€ìˆ˜ë“¤ ì´ˆê¸°í™”
            encryptedPdfPages = [];
            decryptedPdfPages = [];
            currentEncPage = 0;
            currentDecPage = 0;
            currentFileType = null;
        }

        // PDF í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜ë“¤ (í•œê¸€ ì£¼ì„: ì•”í˜¸í™”ëœ PDFì™€ ë³µí˜¸í™”ëœ PDF í˜ì´ì§€ ê´€ë¦¬)
        async function displayEncryptedPage() {
            if (encryptedPdfPages.length === 0) return;
            const canvas = document.getElementById('encryptedCanvas');
            const ctx = canvas.getContext('2d');
            const pageInfo = document.getElementById('encPageInfo');
            pageInfo.textContent = (currentEncPage + 1) + ' / ' + encryptedPdfPages.length;

            // í˜ì´ì§€ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” (í•œê¸€ ì£¼ì„: ì²« í˜ì´ì§€/ë§ˆì§€ë§‰ í˜ì´ì§€ ì²˜ë¦¬)
            document.getElementById('encPrevPageBtn').disabled = currentEncPage === 0;
            document.getElementById('encNextPageBtn').disabled = currentEncPage === encryptedPdfPages.length - 1;

            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const x = (canvas.width - img.width * scale) / 2;
                const y = (canvas.height - img.height * scale) / 2;
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
            };
            img.src = encryptedPdfPages[currentEncPage];
        }

        async function displayDecryptedPage() {
            if (decryptedPdfPages.length === 0) return;
            const canvas = document.getElementById('decryptedCanvas');
            const ctx = canvas.getContext('2d');
            const pageInfo = document.getElementById('decPageInfo');
            pageInfo.textContent = (currentDecPage + 1) + ' / ' + decryptedPdfPages.length;

            // í˜ì´ì§€ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” (í•œê¸€ ì£¼ì„: ì²« í˜ì´ì§€/ë§ˆì§€ë§‰ í˜ì´ì§€ ì²˜ë¦¬)
            document.getElementById('decPrevPageBtn').disabled = currentDecPage === 0;
            document.getElementById('decNextPageBtn').disabled = currentDecPage === decryptedPdfPages.length - 1;

            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const x = (canvas.width - img.width * scale) / 2;
                const y = (canvas.height - img.height * scale) / 2;
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
            };
            img.src = decryptedPdfPages[currentDecPage];
        }

        // ë³µí˜¸í™” ê²€ì¦ í•¨ìˆ˜ (í•œê¸€ ì£¼ì„: ì›ë³¸ê³¼ ë³µí˜¸í™” ê²°ê³¼ê°€ ë‹¤ë¥¸ì§€ í™•ì¸)
        async function verifyDecryption(originalPages, decryptedPages) {
            if (!originalPages || !decryptedPages) return false;
            if (originalPages.length !== decryptedPages.length) return true; // í˜ì´ì§€ ìˆ˜ê°€ ë‹¤ë¥´ë©´ ë³µí˜¸í™”ë¨
            
            // ì²« ë²ˆì§¸ í˜ì´ì§€ ë¹„êµ (ê°„ë‹¨í•œ ê²€ì¦)
            if (originalPages.length > 0 && decryptedPages.length > 0) {
                return originalPages[0] !== decryptedPages[0];
            }
            return false;
        }

        // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜ (í•œê¸€ ì£¼ì„: ì´ë¯¸ì§€/PDF íŒŒì¼ ì²˜ë¦¬ ë° ë¯¸ë¦¬ë³´ê¸°)
        async function handleFile(file) {
            if (!file) return;

            // íŒŒì¼ í˜•ì‹ ê²€ì¦
            if (!file.type.match('image/jpeg') && file.type !== 'application/pdf') {
                errorDiv.textContent = 'JPG ë˜ëŠ” PDF í˜•ì‹ì˜ íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.';
                resetPreview();
                return;
            }

            errorDiv.textContent = '';
            currentFileType = file.type;
            
            // ì›ë³¸ íŒŒì¼ ì •ë³´ ì €ì¥ (í•œê¸€ ì£¼ì„: ë³µí˜¸í™” ë¹„êµìš©)
            window.originalFileSize = file.size;
            // ì›ë³¸ íŒŒì¼ ì •ë³´ ê¸°ë¡
            
            // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™” í›„ ìƒˆ íŒŒì¼ í‘œì‹œ
            resetPreview();
            document.getElementById('decryptButton').disabled = false;
            previewPlaceholder.style.display = 'none';

            // íŒŒì¼ í˜•ì‹ì— ë”°ë¥¸ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬
            if (file.type.match('image/jpeg')) {
                // JPG íŒŒì¼ì˜ ê²½ìš° ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
                encryptedImage.style.display = 'block';
                const reader = new FileReader();
                reader.onload = function(event) {
                    encryptedImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                // PDF íŒŒì¼ì˜ ê²½ìš° ë³€í™˜ í›„ ë¯¸ë¦¬ë³´ê¸° (í•œê¸€ ì£¼ì„: encrypt.htmlê³¼ ë™ì¼í•œ PDF ì²˜ë¦¬)
                document.getElementById('encryptedLoadingSpinner').style.display = 'block';
                previewPlaceholder.style.display = 'none';
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/convert-pdf', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('PDF ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    const result = await response.json();
                    encryptedPdfPages = result.pages;
                    currentEncPage = 0;
                    
                    // PDF ìº”ë²„ìŠ¤ í‘œì‹œ
                    document.getElementById('encryptedCanvas').style.display = 'block';
                    document.getElementById('encryptedPdfControls').style.display = encryptedPdfPages.length > 1 ? 'block' : 'none';
                    
                    await displayEncryptedPage();
                    
                } catch (error) {
                    errorDiv.textContent = error.message;
                    previewPlaceholder.innerHTML = `ğŸ“„ PDF íŒŒì¼: ${file.name} (ë³€í™˜ ì‹¤íŒ¨)`;
                    previewPlaceholder.style.display = 'block';
                } finally {
                    document.getElementById('encryptedLoadingSpinner').style.display = 'none';
                }
            }
        }

        // íŒŒì¼ input í´ë¦­ ì‹œ ì´ˆê¸°í™” ë° ì²˜ë¦¬
        imageInput.addEventListener('click', function() {
            resetPreview();
        });

        // íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            handleFile(file);
        });

        // PDF í˜ì´ì§€ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ (í•œê¸€ ì£¼ì„: ì•”í˜¸í™”ëœ PDF í˜ì´ì§€ ë„˜ê¸°ê¸°)
        document.getElementById('encPrevPageBtn').addEventListener('click', function() {
            if (currentEncPage > 0) {
                currentEncPage--;
                displayEncryptedPage();
            }
        });

        document.getElementById('encNextPageBtn').addEventListener('click', function() {
            if (currentEncPage < encryptedPdfPages.length - 1) {
                currentEncPage++;
                displayEncryptedPage();
            }
        });

        // ë³µí˜¸í™”ëœ PDF í˜ì´ì§€ ë„˜ê¸°ê¸°
        document.getElementById('decPrevPageBtn').addEventListener('click', function() {
            if (currentDecPage > 0) {
                currentDecPage--;
                displayDecryptedPage();
            }
        });

        document.getElementById('decNextPageBtn').addEventListener('click', function() {
            if (currentDecPage < decryptedPdfPages.length - 1) {
                currentDecPage++;
                displayDecryptedPage();
            }
        });

        // ë“œë˜ê·¸ì•¤ë“œë¡­ ê¸°ëŠ¥ ì¶”ê°€ (í•œê¸€ ì£¼ì„: encrypt.htmlê³¼ ë™ì¼í•œ ë“œë˜ê·¸ì•¤ë“œë¡­ ì§€ì›)
        const previewBox = document.getElementById('previewBox');
        
        previewBox.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            previewBox.style.background = '#e0e7ff';
        });

        previewBox.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            previewBox.style.background = '';
        });

        previewBox.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            previewBox.style.background = '';
            
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                imageInput.files = e.dataTransfer.files;
                handleFile(file);
            }
        });

        // ë³µí˜¸í™” ë²„íŠ¼ í´ë¦­ ì‹œ ë³µí˜¸í™” ìš”ì²­
        document.getElementById('decryptButton').addEventListener('click', async function() {
            const file = imageInput.files[0];
            if (!file) return;

            // ë³µí˜¸í™”ëœ íŒŒì¼ ì˜ì—­ì— ìŠ¤í”¼ë„ˆ í‘œì‹œ (í•œê¸€ ì£¼ì„: ë³µí˜¸í™” ì‹œì‘ ì‹œ ìš°ì¸¡ ì˜ì—­ì— ìŠ¤í”¼ë„ˆ)
            document.getElementById('decryptedLoadingSpinner').style.display = 'block';
            decryptedPlaceholder.style.display = 'none';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/decrypt', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errorMessage = 'ë³µí˜¸í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    try {
                        const error = await response.json();
                        errorMessage = error.error + (error.details ? '\n\nìƒì„¸ ì˜¤ë¥˜:\n' + error.details : '');
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                // íŒŒì¼ í˜•ì‹ì— ë”°ë¥¸ ê²°ê³¼ í‘œì‹œ (í•œê¸€ ì£¼ì„: PDF/ì´ë¯¸ì§€ êµ¬ë¶„í•˜ì—¬ ì²˜ë¦¬)
                if (file.type === 'application/pdf') {
                    // PDF ë³µí˜¸í™” ê²°ê³¼ë¥¼ ë³€í™˜í•˜ì—¬ í˜ì´ì§€ë³„ë¡œ í‘œì‹œ
                    try {
                        // blobì„ File ê°ì²´ë¡œ ë³€í™˜ (í•œê¸€ ì£¼ì„: ë” ì •í™•í•œ íŒŒì¼ ì „ì†¡)
                        const decryptedFile = new File([blob], 'decrypted.pdf', { 
                            type: 'application/pdf',
                            lastModified: Date.now()
                        });
                        
                        const pdfFormData = new FormData();
                        pdfFormData.append('file', decryptedFile);
                        
                        // íŒŒì¼ í¬ê¸° ë¹„êµ ë° ê²€ì¦
                        if (Math.abs(blob.size - window.originalFileSize) < 100) {
                            // íŒŒì¼ í¬ê¸°ê°€ ê±°ì˜ ë™ì¼í•œ ê²½ìš° ì²˜ë¦¬
                        }
                        
                        const pdfResponse = await fetch('/convert-pdf', {
                            method: 'POST',
                            body: pdfFormData
                        });
                        
                        if (pdfResponse.ok) {
                            const pdfResult = await pdfResponse.json();
                            decryptedPdfPages = pdfResult.pages;
                            currentDecPage = 0;
                            
                            // ë³µí˜¸í™” ì„±ê³µ ì—¬ë¶€ í™•ì¸ (í•œê¸€ ì£¼ì„: ì›ë³¸ê³¼ ë‹¤ë¥¸ì§€ í™•ì¸)
                            const isDecrypted = await verifyDecryption(encryptedPdfPages, decryptedPdfPages);
                            
                            document.getElementById('decryptedCanvas').style.display = 'block';
                            document.getElementById('decryptedPdfControls').style.display = decryptedPdfPages.length > 1 ? 'block' : 'none';
                            await displayDecryptedPage();
                            
                            // ë³µí˜¸í™” ê²°ê³¼ ê²€ì¦ ë° ì²˜ë¦¬
                            if (!isDecrypted) {
                                // ë³µí˜¸í™” ê²°ê³¼ê°€ ì›ë³¸ê³¼ ë™ì¼í•œ ê²½ìš° ì²˜ë¦¬
                            }
                        } else {
                            const errorText = await pdfResponse.text();
                            // PDF ë³€í™˜ ì‹¤íŒ¨ ì²˜ë¦¬
                            decryptedPlaceholder.innerHTML = `ğŸ“„ ë³µí˜¸í™”ëœ PDF (ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: ${pdfResponse.status})`;
                            decryptedPlaceholder.style.display = 'block';
                        }
                    } catch (pdfError) {
                        // PDF ë³€í™˜ ì˜¤ë¥˜ ì²˜ë¦¬
                        decryptedPlaceholder.innerHTML = `ğŸ“„ ë³µí˜¸í™”ëœ PDF (ë³€í™˜ ì˜¤ë¥˜: ${pdfError.message})`;
                        decryptedPlaceholder.style.display = 'block';
                    }
                    
                    downloadButton.textContent = 'PDF ë‹¤ìš´ë¡œë“œ';
                } else {
                    // ì´ë¯¸ì§€ ë³µí˜¸í™” ê²°ê³¼ í‘œì‹œ
                    previewImage.src = url;
                    previewImage.style.display = 'block';
                    downloadButton.textContent = 'ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ';
                }
                
                downloadButton.style.display = 'block';

                // ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ì„¤ì • (í•œê¸€ ì£¼ì„: íŒŒì¼ëª… ì„¤ì • ê¸°ëŠ¥ ì¶”ê°€)
                downloadButton.onclick = function() {
                    const filenameInput = document.getElementById('outputFilename');
                    
                    // íŒŒì¼ í˜•ì‹ì— ë”°ë¥¸ ê¸°ë³¸ íŒŒì¼ëª… ë° í™•ì¥ì ì„¤ì • (í•œê¸€ ì£¼ì„: PDFì™€ ì´ë¯¸ì§€ êµ¬ë¶„)
                    let defaultName, extension;
                    if (file.type === 'application/pdf') {
                        extension = '.pdf';
                        defaultName = 'decrypted_document.pdf';
                    } else {
                        extension = '.jpg';
                        defaultName = 'decrypted_image.jpg';
                    }

                    if (file) {
                        const nameParts = file.name.split('.');
                        const base = nameParts.slice(0, -1).join('.') || file.name;
                        defaultName = base + '_dec' + extension;
                    }

                    let filename = filenameInput?.value?.trim() || '';
                    if (filename === '') filename = defaultName;
                    
                    // í™•ì¥ì ì²˜ë¦¬: íŒŒì¼ í˜•ì‹ì— ë§ëŠ” í™•ì¥ìë¡œ ê°•ì œ ì„¤ì •
                    if (!filename.endsWith(extension)) {
                        filename = filename.replace(/\.[^/.]+$/, '');
                        filename += extension;
                    }

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // ë‹¤ìš´ë¡œë“œ í›„ URL ì •ë¦¬
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 1000);
                };
            } catch (error) {
                // ë³µí˜¸í™” ì˜¤ë¥˜ ì²˜ë¦¬
                if (error.message.includes('ê°œì¸í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                    errorDiv.textContent = 'ì´ ê¸°ê¸°ì—ì„œ ë°œê¸‰ëœ ê°œì¸í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì´ë©”ì¼ ì¸ì¦ì„ í†µí•´ ê°œì¸í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ì£¼ì„¸ìš”.';
                } else {
                    errorDiv.textContent = error.message;
                }
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ placeholder ë‹¤ì‹œ í‘œì‹œ
                decryptedPlaceholder.style.display = 'block';
            } finally {
                // ë³µí˜¸í™” ì™„ë£Œ í›„ ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                document.getElementById('decryptedLoadingSpinner').style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
