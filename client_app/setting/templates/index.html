{% extends "layout.html" %}

{% block title %}Encra - í™ˆ{% endblock %}

{% block additional_styles %}
<style>
  /* ì „ì²´ í™”ë©´ ì¤‘ì•™ ì •ë ¬ ë° íŒ¨ë”© */
  .main-container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    padding: 20px 10px;
    background-color: #f9fafb;
  }

  /* ë‚´ë¶€ ì½˜í…ì¸  ë°•ìŠ¤ */
  .content-wrapper {
    width: 100%;
    max-width: 960px;
    padding: 48px 32px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .page-heading {
    font-size: 2.2rem;
    font-weight: 800;
    color: #1e3a8a;
    margin-bottom: 28px;
  }
/* ê³µí†µ ìŠ¤íƒ€ì¼ */
  #auth-status {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 28px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 16px 24px;
    border-radius: 12px;
    transition: all 0.3s ease-in-out;
  }
  
  /* ì„±ê³µ ë©”ì‹œì§€ */
  #auth-status.success {
    color: #166534; /* ì´ˆë¡ ê³„ì—´ (Tailwind: green-800) */
    border: 2px solid #22c55e;
  }

  /* ì‹¤íŒ¨ ë©”ì‹œì§€ */
  #auth-status.error {
    color: #c2410c; /* ê°•ì¡°ëŠ” ìˆì§€ë§Œ ë¶€ë“œëŸ¬ìš´ ì£¼í™©-ë¶‰ì€ìƒ‰ */
    border: 2px solid #f56565;
  }

  /* ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ ë©”ì‹œì§€ (ìƒˆë¡œ ì¶”ê°€) */
  #auth-status.email-sent {
    color: #1e40af; /* íŒŒë€ìƒ‰ í…ìŠ¤íŠ¸ */
    border: 2px solid #3b82f6;
    animation: pulse 2s ease-in-out 3; /* 3ë²ˆ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
  }

  /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
  @keyframes pulse {
    0%, 100% { 
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
    }
    50% { 
      transform: scale(1.02);
      box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
    }
  }

  /* ê¸°ë³¸ ìƒíƒœ (ì¸ì¦ í™•ì¸ ì¤‘) */
  #auth-status.checking {
    color: #6b7280;
    background-color: #f9fafb;
    border: 2px solid #d1d5db;
  }

  /* ì¸ì¦ í›„ ë²„íŠ¼ ê·¸ë£¹ */
  .action-buttons {
    display: flex;
    gap: 32px;
    margin-top: 48px;
    justify-content: center;
    flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
  }

  /* í‚¤ì˜¤ìŠ¤í¬ ìŠ¤íƒ€ì¼ ë²„íŠ¼ */
  .kiosk-btn {
    font-size: 1.4rem;
    padding: 20px 40px;
    border-radius: 12px;
    border: none;
    background: #1976d2;
    color: #fff;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.15);
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    min-width: 220px;
    min-height: 70px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
  }

  .kiosk-btn:hover {
    background: #125ea2;
    transform: scale(1.03);
  }

  /* ì¸ì¦ í•„ìš” ì•ˆë‚´ ì˜ì—­ */
  .auth-section {
    margin-top: 24px;
    text-align: center;
  }

  .auth-section p {
    font-size: 1rem;
    color: #444;
    margin-bottom: 16px;
  }

  .auth-section .btn {
    padding: 10px 24px;
    font-size: 1rem;
    border-radius: 8px;
    background: #1976d2;
    color: white;
    border: none;
    text-decoration: none;
    display: inline-block;
    transition: background 0.2s;
  }

  .auth-section .btn:hover {
    background: #125ea2;
  }
  .guide-section {
    max-width: 960px;
    width: 100%;
    padding: 40px;
    background: #f1f5f9;
    border-radius: 16px;
    text-align: center;
  }

  .guide-section h2 {
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 16px;
    color: #1e3a8a;
  }

  .guide-section p {
    font-size: 1rem;
    color: #444;
    margin-bottom: 32px;
  }

  .step-container {
    display: grid;
    grid-template-columns: repeat(2, minmax(220px, 1fr));
    gap: 24px;
    justify-items: center;
  }

  .step-box {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    width: 100%;
    max-width: 360px;
    min-height: 140px;
    /* ğŸ‘‡ Flexbox ì„¸ë¡œ êµ¬ì„± */
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
  }

  .step-box h3 {
    font-size: 1.1rem;
    color: #0f172a;
    margin-bottom: 8px;
  }

  .step-box p {
    font-size: 0.95rem;
    color: #555;
    margin-top: auto;   /* ì•„ë˜ìª½ì—ì„œ ê³µê°„ ì°¨ì§€ */
    margin-bottom: auto; /* ìœ„ì—ì„œ ê³µê°„ ì°¨ì§€ â†’ ìˆ˜ì§ ì¤‘ì•™ */
  }
  /* ë°˜ì‘í˜• ëŒ€ì‘ */
  @media (max-width: 600px) {
    .kiosk-btn {
      font-size: 1rem;
      padding: 16px 20px;
      min-width: 160px;
      min-height: 60px;
    }
    .content-wrapper {
      padding: 32px 16px;
    }
    .action-buttons {
      gap: 16px;
    }
  }
</style>

{% endblock %}

{% block content %}
<div class="main-container">
  <div class="content-wrapper">
    <div class="page-heading">Encra ì´ë¯¸ì§€ ë³´ì•ˆ ì„œë¹„ìŠ¤</div>
    <div id="auth-status">
      ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <div id="action-buttons" style="display: none;">
      <div class="action-buttons">
        <a href="{{ url_for('encryption_view.show_encrypt_page') }}" class="kiosk-btn">ğŸ” ì´ë¯¸ì§€ ì•”í˜¸í™”</a>
        <a href="{{ url_for('decryption_view.show_decrypt_page') }}" class="kiosk-btn">ğŸ”“ ì´ë¯¸ì§€ ë³µí˜¸í™”</a>
      </div>
    </div>
    <div id="auth-section" class="auth-section">
      <p>ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì´ë©”ì¼ ì¸ì¦ì„ í•´ì£¼ì„¸ìš”.</p>
      <a href="{{ url_for('auth.request_auth') }}" class="btn">ì´ë©”ì¼ ì¸ì¦í•˜ê¸°</a>
    </div>
  </div>

  <div class="guide-section">
    <h2>ğŸ›¡ï¸ Encraë€?</h2>
    <p>EncraëŠ” ë¯¼ê°í•œ ì´ë¯¸ì§€ì˜ íŠ¹ì • ë¶€ë¶„(ì˜ˆ: ì–¼êµ´, ë¬¸ì„œ ë“±)ì„ ì„ íƒí•´ ì•”í˜¸í™”í•˜ê³ , <br>ì•ˆì „í•˜ê²Œ ì „ì†¡í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ì´ë¯¸ì§€ ë³´ì•ˆ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.</p>

    <div class="step-container">
      <div class="step-box">
        <h3>â‘  ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
        <p>ì•”í˜¸í™”í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</p>
      </div>
      <div class="step-box">
        <h3>â‘¡ ì•”í˜¸í™” ì˜ì—­ ì§€ì •</h3>
        <p>ë“œë˜ê·¸í•˜ì—¬ ë³´í˜¸í•  ì˜ì—­ì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
      </div>
      <div class="step-box">
        <h3>â‘¢ ìˆ˜ì‹ ì ì´ë©”ì¼ ì…ë ¥</h3>
        <p>ì—¬ëŸ¬ ëª…ì˜ ì´ë©”ì¼ì„ ì…ë ¥í•´ í•œ íŒŒì¼ë¡œ <br>ì—¬ëŸ¬ ëª…ì—ê²Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="step-box">
        <h3>â‘£ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</h3>
        <p>ì•”í˜¸í™”ëœ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ê³  ì „ì†¡í•˜ì„¸ìš”.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
  function hideAlerts() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
      setTimeout(() => {
        alert.style.transition = 'opacity 0.5s ease-in-out';
        alert.style.opacity = '0';
        setTimeout(() => {
          alert.remove();
        }, 500);
      }, 5000);
    });
  }

  async function checkAuthStatus() {
    try {
      const response = await fetch('/auth/check');
      const data = await response.json();
      const authStatus = document.getElementById('auth-status');
      const actionButtons = document.getElementById('action-buttons');
      const authSection = document.getElementById('auth-section');
      
      if (data.has_key) {
        authStatus.innerHTML = 'âœ… ê°œì¸í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
        authStatus.className = 'success'; // ìƒ‰ìƒ í´ë˜ìŠ¤ ì ìš©
        actionButtons.style.display = 'flex';
        authSection.style.display = 'none';
      } else {
        authStatus.innerHTML = 'âŒ ê°œì¸í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        authStatus.className = 'error'; // ìƒ‰ìƒ í´ë˜ìŠ¤ ì ìš©
        actionButtons.style.display = 'none';
        authSection.style.display = 'block';
      }
    } catch (error) {
      // ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ ì²˜ë¦¬
      const authStatus = document.getElementById('auth-status');
      authStatus.innerHTML = 'âš ï¸ ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      authStatus.className = 'error';
    }
  }

  // í•œê¸€ ì£¼ì„: ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
  function handleEmailSentMessage() {
    const authStatus = document.getElementById('auth-status');
    
    // í•œê¸€ ì£¼ì„: Flash ë©”ì‹œì§€ì—ì„œ ì´ë©”ì¼ ë°œì†¡ ë©”ì‹œì§€ í™•ì¸
    const successAlerts = document.querySelectorAll('.alert-success');
    let emailSentMessage = '';
    
    successAlerts.forEach(alert => {
      if (alert.textContent.includes('ì¸ì¦ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤') || 
          alert.textContent.includes('ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”')) {
        emailSentMessage = alert.textContent.trim();
        // í•œê¸€ ì£¼ì„: ê¸°ì¡´ alert ìˆ¨ê¸°ê¸° (authStatusì—ì„œ ë” ëˆˆì— ë„ê²Œ í‘œì‹œí•  ì˜ˆì •)
        alert.style.display = 'none';
      }
    });
    
    // í•œê¸€ ì£¼ì„: ì´ë©”ì¼ ë°œì†¡ ê´€ë ¨ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ (ê¸°ì¡´ ì¡°ê±´ + Flash ë©”ì‹œì§€ í™•ì¸)
    if (authStatus.innerHTML.includes('ì¸ì¦ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤') || 
        authStatus.innerHTML.includes('ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”') ||
        emailSentMessage) {
      
      authStatus.className = 'email-sent';
      authStatus.innerHTML = `
        ğŸ“§ <strong>ì¸ì¦ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!</strong><br>
        <span style="font-size: 1.1rem; margin-top: 8px; display: block;">
          ğŸ“® ì´ë©”ì¼í•¨ì„ í™•ì¸í•˜ê³  ì¸ì¦ ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”
        </span>
        <span style="font-size: 0.95rem; color: #64748b; margin-top: 6px; display: block;">
          ë©”ì¼ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ ìŠ¤íŒ¸í•¨ë„ í™•ì¸í•´ë³´ì„¸ìš”
        </span>
      `;
      
      // í•œê¸€ ì£¼ì„: 15ì´ˆ í›„ ê¸°ë³¸ ì¸ì¦ í•„ìš” ë©”ì‹œì§€ë¡œ ë³€ê²½ (ì‹œê°„ ì—°ì¥)
      setTimeout(() => {
        authStatus.innerHTML = 'âŒ ê°œì¸í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        authStatus.className = 'error';
      }, 15000);
    }
  }
  
  window.onload = () => {
    // í•œê¸€ ì£¼ì„: ê¸°ë³¸ ìƒíƒœë¥¼ checkingìœ¼ë¡œ ì„¤ì •
    const authStatus = document.getElementById('auth-status');
    authStatus.className = 'checking';
    
    checkAuthStatus();
    hideAlerts();
    
    // í•œê¸€ ì£¼ì„: í˜ì´ì§€ ë¡œë“œ í›„ ì´ë©”ì¼ ë°œì†¡ ë©”ì‹œì§€ í™•ì¸ (ë‹¤ì¤‘ ì‹œë„ë¡œ ì•ˆì •ì„± í™•ë³´)
    setTimeout(handleEmailSentMessage, 100);
    setTimeout(handleEmailSentMessage, 500);
    setTimeout(handleEmailSentMessage, 1000);
    
    // í•œê¸€ ì£¼ì„: URL íŒŒë¼ë¯¸í„°ë¡œ ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ ìƒíƒœ í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('email_sent') === 'true') {
      setTimeout(() => {
        const authStatus = document.getElementById('auth-status');
        authStatus.className = 'email-sent';
        authStatus.innerHTML = `
          ğŸ“§ <strong>ì¸ì¦ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!</strong><br>
          <span style="font-size: 1.1rem; margin-top: 8px; display: block;">
            ğŸ“® ì´ë©”ì¼í•¨ì„ í™•ì¸í•˜ê³  ì¸ì¦ ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”
          </span>
          <span style="font-size: 0.95rem; color: #64748b; margin-top: 6px; display: block;">
            ë©”ì¼ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ ìŠ¤íŒ¸í•¨ë„ í™•ì¸í•´ë³´ì„¸ìš”
          </span>
        `;
        
        setTimeout(() => {
          authStatus.innerHTML = 'âŒ ê°œì¸í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.';
          authStatus.className = 'error';
        }, 15000);
      }, 200);
    }
  };
</script>
{% endblock %}
